{% extends 'base.html' %}

{% block header %}
    <div class="row noprint">
        <div class="col-sm-12 col-md-12">
            <ol class="breadcrumb">
                <li><a href="{% url 'change:provisions' %}">Provisions</a></li>
                <li>#{{ provision_set.id }}</li>
            </ol>
        </div>
    </div>
    <div class="pull-right noprint">
        {% if perms.change.change_provisionset and provision_set.state != provision_set.FINISHED %}
            <form action="{% url 'change:second_stage' pk=provision_set.pk %}" method="post" style="display: inline-block">
                {% csrf_token %}
                <button type="submit" class="btn btn-warning"{% if provision_set.state != provision_set.REVIEWING %} disabled="" title="First stage did not complete successfully"{% endif %}>
                    <i class="glyphicon glyphicon-play" aria-hidden="true"></i> Commit
                </button>
            </form>
            <button class="btn btn-danger"{% if provision_set.is_final_state %} disabled="" title="Cannot be terminated!"{% endif %} data-toggle="modal" data-target="#termination-modal">
                <i class="glyphicon glyphicon-ban-circle" aria-hidden="true"></i> Terminate
            </button>
        {% endif %}
    </div>
    <h1>
        {% block title %}Provisioning #{{ provision_set.pk }}{% endblock %}
        <small>
            {% include 'change/inc/provision_set_label.html' %}
            {% if provision_set.reverted %}
                <span class="label label-danger" style="margin-left: 0.5em">Reverted</span>
            {% endif %}
        </small>
    </h1>
    <p>
    <small class="text-muted">Created {{ provision_set.created }} &middot; Updated <span title="{{ provision_set.updated }}">{{ provision_set.updated | timesince }}</span> ago</small>
    </p>

    {# Modal dialog for termination #}
    <div class="modal fade" tabindex="-1" role="dialog" aria-labelledby="termination-modal-label" id="termination-modal">
        <div class="modal-dialog modal-sm" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="termination-modal-label">Terminate Provisioning</h4>
                </div>
                <div class="modal-body">
                    Do you really want to terminate this provisioning?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <form action="{% url 'change:terminate_provision_set' pk=provision_set.pk %}" method="post" style="display: inline-block">
                        {% csrf_token %}
                        <button class="btn btn-danger" type="submit">Terminate</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block content %}
    <div class="row">
        <div class="col-md-8">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <strong>Logs</strong>
                </div>
                <div class="panel-body" id="react-terminal" style="padding: 0;">
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="panel panel-default">
                <div class="panel-heading"><strong>Information</strong></div>
                <table class="table table-hover panel-body attr-table">
                    <tr>
                        <td>Author</td>
                        <td>{{ provision_set.user.username }}</td>
                    </tr>
                </table>
            </div>
            {% include 'panel_table.html' with table=changes_table heading='Containing changes' %}
        </div>
    </div>
{% endblock %}

{% block javascript %}
    <script type="application/javascript">
    document.addEventListener('DOMContentLoaded', () => {
        ReactDOM.render(
            React.createElement(
                window.ReactComponents.ProvisionTerminal,
                {
                    provisionId: "{{ provision_set.pk }}",
                    {% if provision_set.status != provision_set.RUNNING %}
                        {% autoescape off %}
                            initialContent: {{ provision_set.output_log | stringformat:'r' }}.replace(/\n/g, '\r\n'),
                        {% endautoescape %}
                    {% else %}
                        initialContent: "",
                    {% endif %}
                }
            ),
            document.getElementById('react-terminal'),
        );
        var term = new Terminal({
            rows: 50,
            disableStdin: true,
            scrollback: 1000000,
            rendererType: "dom",
            convertEol: true,
            theme: {
                selection: 'rgba(255, 124, 0, 0.5)',
            }
        });
        var fit_addon = new FitAddon.FitAddon();
        var web_links_addon = new WebLinksAddon.WebLinksAddon();
        term.attachCustomKeyEventHandler((_e) => false);
        term.loadAddon(fit_addon);
        term.loadAddon(web_links_addon);
        term.open(document.getElementById('terminal_output'));
        fit_addon.fit();

        var path = '/ws/change/provisions/{{ provision_set.pk }}/logs/';
        var url = new URL(path, window.location.href);
        url.protocol = url.protocol.replace('http', 'ws');

        var sock = new WebSocket(url);
        sock.onmessage = (ev) => {
            const data = ev.data;
            if (typeof data === 'string') {
                term.write(data);
            } else {
                let reader = new FileReader()
                reader.addEventListener('loadend', () => {
                    term.write(reader.result)
                })
                reader.readAsBinaryString(data)
            }
        };
    })

    </script>
{% endblock %}
