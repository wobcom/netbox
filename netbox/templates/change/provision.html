{% extends '_base.html' %}

{% block header %}
    <div class="row noprint">
        <div class="col-sm-12 col-md-12">
            <ol class="breadcrumb">
                <li><a href="{% url 'change:provisions' %}">Provisions</a></li>
                <li>#{{ provision_set.id }}</li>
            </ol>
        </div>
    </div>
    <div class="pull-right noprint">
        {% if perms.change.edit_provisionset %}
            <button class="btn btn-danger"{% if provision_set.status != 1 %} disabled="" title="Not running processes cannot be terminated!"{% endif %} data-toggle="modal" data-target="#termination-modal">
                <i class="glyphicon glyphicon-ban-circle"></i> Terminate
            </button>
        {% endif %}
    </div>
    <h1>
        {% block title %}Provisioning #{{ provision_set.pk }}{% endblock %}
        <small>
            <span class="label label-{% if provision_set.status == RUNNING %}info{% elif provision_set.status == FINISHED %}success{% elif provision_set.status == FAILED %}danger{% elif provision_set.status == ABORTED %}warning{% endif %}">
                {{provision_set.get_status_display}}
            </span>
        </small>
    </h1>
    <p>
    <small class="text-muted">Created {{ provision_set.created }} &middot; Updated <span title="{{ provision_set.updated }}">{{ provision_set.updated | timesince }}</span> ago</small>
    </p>

    {# Modal dialog for termination #}
    <div class="modal fade" tabindex="-1" role="dialog" aria-labelledby="termination-modal-label" id="termination-modal">
        <div class="modal-dialog modal-sm" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="termination-modal-label">Modal title</h4>
                </div>
                <div class="modal-body">
                    Do you really want to terminate this provisioning?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <a href="{% url 'change:terminate_provision_set' pk=provision_set.pk %}" type="button" class="btn btn-danger">Terminate</a>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block content %}
    <div class="row">
        <div class="col-md-6">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <strong>Logs</strong>
                </div>
                <div id="terminal_output"></div>
            </div>
        </div>
        <div class="col-md-6">
            {% include 'panel_table.html' with table=changes_table heading='Containing changes' %}
        </div>
    </div>
{% endblock %}

{% block javascript %}
    <script type="application/javascript">
    document.addEventListener('DOMContentLoaded', () => {
        var term = new Terminal({
            rows: 50,
        });
        var fit_addon = new FitAddon.FitAddon();
        term.loadAddon(fit_addon);
        term.open(document.getElementById('terminal_output'));
        fit_addon.fit();
        {% if provision_set.output_log %}
        term.write(`{{ provision_set.output_log }}`.replace(/\n/g, '\r\n'));
        {% else %}
        var websocket = new WebSocket((location.protocol.startsWith('https') ? 'wss' : 'ws') + '://' + location.host + '/change/provisions/{{ provision_set.pk }}/logs/ws/');
        websocket.onmessage = (msg) => {
            var data = JSON.parse(msg.data);
            if (data.scope === 'default') {
                term.write(data.line.replace(/\n/g, '\r\n'));
            }
        };
        {% endif %}
    })

    </script>
{% endblock %}
