services:
  - postgres:9.6
  - redis:latest

variables:
  POSTGRES_DB: netbox
  POSTGRES_USER: root
  POSTGRES_PASSOWRD: ""
  POSTGRES_HOST_AUTH_METHOD: trust

stages:
  - test
  - build

lint:
  stage: test
  image: python:3.6
  tags:
    - docker
  script:
    - "pip install virtualenv"
    - "virtualenv --python=python3.6 venv"
    - "venv/bin/pip install pycodestyle"
    - "venv/bin/pycodestyle --ignore=W504,E501 netbox/"

eslint:
  stage: test
  image: node:latest
  tags:
    - docker
  script:
    - "yarn install"
    - "yarn run eslint --ignore-pattern netbox/project-static/wobcom/dist netbox/project-static/wobcom/wobcom.js netbox/project-static/wobcom"

tests:
  stage: test
  image: python:3.6
  tags:
    - docker
  before_script:
    - "git config --global credential.helper store"
    - "echo https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.service.wobcom.de >> ~/.git-credentials"
    - "cat ~/.git-credentials"
  script:
    - "apt update"
    - "apt install -y libldap2-dev python3-dev libsasl2-dev"
    - "pip install virtualenv"
    - "virtualenv --python=python3.6 venv"
    - "venv/bin/pip install -r requirements.txt"
    - "cp -f netbox/netbox/configuration.testing.py netbox/netbox/configuration.py"
    - "cd netbox/"
    - "../venv/bin/python manage.py test"

check_version:
  stage: test
  image: python:3.6
  tags:
    - docker
  only:
    - tags
  script:
    - "python check_version.py"

build:
  stage: build
  tags:
    - docker-build
  only:
    - tags
  dependencies:
    - check_version
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build --cache-from $CI_REGISTRY_IMAGE:latest --build-arg CI_JOB_TOKEN --tag $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_NAME --tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA --tag $CI_REGISTRY_IMAGE:latest .
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_NAME
    - docker push $CI_REGISTRY_IMAGE:latest
    - docker logout $CI_REGISTRY
    - docker image rm --force $CI_REGISTRY_IMAGE
