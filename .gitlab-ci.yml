services:
  - postgres:9.6
  - redis:latest

variables:
  POSTGRES_DB: netbox
  POSTGRES_USER: root
  POSTGRES_PASSOWRD: ""
  POSTGRES_HOST_AUTH_METHOD: trust

stages:
  - validate
  - build
  - push_unstable
  - test
  - push
  - lint
  - cleanup

check_version:
  stage: validate
  image: python:3.6
  tags:
    - docker
  only:
    - tags
  script:
    - "python check_version.py"

build:
  stage: build
  tags:
    - docker-build
  dependencies:
    - check_version
  script:
    - docker build --cache-from $CI_REGISTRY_IMAGE:latest --build-arg CI_JOB_TOKEN --tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA  .
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
    - docker push $CI_REGISTRY_IMAGE:latest_$CI_COMMIT_REF_NAME
    - docker logout $CI_REGISTRY

push_unstable:
  stage: push_unstable
  tags:
    - docker-build
  only:
    - tags
  dependencies:
    - build
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA $CI_REGISTRY_IMAGE:latest_unstable
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
    - docker push $CI_REGISTRY_IMAGE:latest_unstable
    - docker logout $CI_REGISTRY

tests:
  stage: test
  image: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
  tags:
    - docker
  dependencies:
    - build
  script:
    - python /opt/netbox/manage.py test

push_prod_tags:
    stage: push
    tags:
      - docker-build
    only:
      - tags
    dependencies:
      - tests
    script:
      - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
      - docker tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_NAME
      - docker tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA $CI_REGISTRY_IMAGE:latest
      - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_NAME
      - docker push $CI_REGISTRY_IMAGE:latest
      - docker logout $CI_REGISTRY

lint:
  stage: lint
  image: python:3.6
  tags:
    - docker
  script:
    - "pip install virtualenv"
    - "virtualenv --python=python3.6 venv"
    - "venv/bin/pip install pycodestyle"
    - "venv/bin/pycodestyle --ignore=W504,E501 netbox/"

eslint:
  stage: lint
  image: node:alpine
  tags:
    - docker
  script:
    - "yarn install"
    - "yarn run eslint --ignore-pattern netbox/project-static/wobcom/dist netbox/project-static/wobcom/wobcom.js netbox/project-static/wobcom"

cleanup:
  stage: cleanup
  tags:
    - docker-build
  dependencies:
    - build
  script:
    - "docker image ls $CI_REGISTRY_IMAGE --quiet | xargs -I {} docker image rm -f {}"
