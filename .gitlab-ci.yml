services:
  - postgres:9.6
  - redis:latest

variables:
  POSTGRES_DB: netbox
  POSTGRES_USER: root
  POSTGRES_PASSOWRD: ""
  POSTGRES_HOST_AUTH_METHOD: trust

stages:
  - verify
  - build
  - deploy

lint:
  stage: verify
  image: python:3.6
  tags:
    - docker
  script:
    - "pip install virtualenv"
    - "virtualenv --python=python3.6 venv"
    - "venv/bin/pip install pycodestyle"
    - "venv/bin/pycodestyle --ignore=W504,E501 netbox/"

tests:
  stage: verify
  image: python:3.6
  tags:
    - docker
  script:
    - "apt update"
    - "apt install -y libldap2-dev python3-dev libsasl2-dev"
    - "pip install virtualenv"
    - "virtualenv --python=python3.6 venv"
    - "venv/bin/pip install -r requirements.txt"
    - "cp -f netbox/netbox/configuration.testing.py netbox/netbox/configuration.py"
    - "cd netbox/"
    - "../venv/bin/python manage.py test"

build-package:
  stage: build
  only:
    - develop
  image: registry.gitlab.com/wobcom/fpm-docker:netbox
  tags:
    - docker
  before_script:
    - "yum install -y python3-devel openldap-devel"
  script:
    - "./build_package.sh"
  artifacts:
    paths:
      - netbox*.rpm

deploy-package:
  stage: deploy
  only:
    - develop
  image: debian:10
  tags:
    - docker
  dependencies:
    - build-package
  before_script:
    - "apt-get -y update"
    - "apt-get install -y sshpass"
    - "mkdir ~/.ssh"
    - "echo ${REPO_HOST_KEY} >> ~/.ssh/known_hosts"
  script:
    - "sshpass -p \"${REPO_PASSWORD}\" scp netbox*.rpm ${REPO_USER}@${REPO_HOST}:${REPO_PATH}"
    - "sshpass -p \"${REPO_PASSWORD}\" ssh ${REPO_USER}@${REPO_HOST} \"/var/share/repos/scripts/rebuild.sh\""
